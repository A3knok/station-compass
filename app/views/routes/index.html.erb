<%= content_for(:title, t('.title')) %>

<div class="alert alert-info text-center mb-0 rounded-0 border-0" role="alert">
  <i class="fas fa-info-circle me-2"></i>
  現在は<strong>渋谷駅</strong>のみ対応しています。今後、他の駅も順次追加予定です!
</div>

<div class="page-container">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="station-sign-bar mb-3"></div>
        <h2 class="text-center mb-5">
          <i class="fas fa-route me-2 text-primary"></i>
          <%= t('.title') %>
        </h2>
      </div>
    </div>

    <div class="row">
      <!-- 左側：投稿一覧 -->
      <div class="col-12 col-lg-8 order-2 order-lg-1">
        <!-- 投稿総数 -->
        <div class="d-flex justify-content-between align-items-center border-bottom mb-4 count-area">
          <h6>
            <i class="fas fa-newspaper text-success me-2"></i>
            <%= t('.total_routes_count') %>
          </h6>
          <span class="badge bg-success fs-6"><%= @routes.count %>件</span>
        </div>

        <!-- ルート概要一覧 -->
        <div class="routes-grid">
          <%= render 'routes/route', 
              routes: @routes,
              show_actions: false %>
        </div>
      </div>
      <!-- 右側：検索フォーム, ランキング -->
      <div class="col-12 col-lg-4 order-1 order-lg-2 mb-4 mb-lg-0">
          <div class="mb-5"><%= render 'routes/search_form'%></div>
          <div class="mb-5"><%= render 'routes/ranking', station: @station %></div>
      </div>
    </div>
  </div>
</div>

<% if !current_user&.guest? %>
  <%= link_to new_route_path, class: "floating-action-button", title: "新規投稿" do %>
    <i class="fas fa-plus"></i>
  <% end %>
<% end %>

<div id="map" style="height: 400px;"></div>

<script>
  function initMap() {
    const currentLatLng = { lat: <%= @station.latitude %>, lng: <%= @station.longitude%> };

    const map = new google.maps.Map(document.getElementById("map"), {
      center: currentLatLng,
      zoom: 16,
    });

    // 駅に青いピンを立てる
    new google.maps.Marker({
      map: map,
      position: currentLatLng,
      title: "<%= @station.name %>",
      icon: {
        url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
      }
    });

    const service = new google.maps.places.PlacesService(map);

    // locationから半径500mの範囲でtypeを検索
    service.nearbySearch( 
      {
        location: currentLatLng,
        radius: 400,
        type: "shopping_mall"
      },
      // 検索結果をresult, 状態をstatusに渡す
      // callback関数の実行
      (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          results.forEach(place => createMarker(place, map));
        } else {
          console.error("場所が見つかりません:", status);
        }
      }
    );
  }

  let currentInfoWindow = null;

  function createMarker(place, map) {
    const marker = new google.maps.Marker({
      map: map,
      position: place.geometry.location
    });

    const contentString = `
        <div style="padding: 10px; max-width: 250px;">
          <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: bold;">${place.name}</h3>
          <p style="margin: 0; font-size: 14px; color: #666;">${place.vicinity || ""}</p>
        </div>
      `;

    const infoWindow = new google.maps.InfoWindow({
      content: contentString
    });

    marker.addListener("click", () => {
      if(currentInfoWindow) {
        currentInfoWindow.close();
      }
      infoWindow.open(map, marker);
      currentInfoWindow = infoWindow; 
    });
  }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=<%= Rails.application.credentials.dig(:google, :maps_api_key) %>&libraries=places&callback=initMap" async defer></script>